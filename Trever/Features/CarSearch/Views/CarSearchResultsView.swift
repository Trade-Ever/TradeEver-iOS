import SwiftUI

struct CarSearchResultsView: View {
    @StateObject private var viewModel = CarSearchViewModel()
    @Environment(\.dismiss) private var dismiss
    
    let searchModel: CarSearchModel
    
    @State private var showSortSheet: Bool = false
    @State private var selectedSortOption: String = "ÏµúÏã†Ïàú"
    
    var body: some View {
        VStack(spacing: 0) {
            // ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
            topNavigationBar
            
            // ÌïÑÌÑ∞ Î≤ÑÌäºÎì§
            filterButtonsRow
            
            // Ï∞®Îüâ Î¶¨Ïä§Ìä∏
            vehiclesList
        }
        .navigationBarHidden(true)
        .task {
            await viewModel.fetchFilteredCars(with: searchModel)
        }
        .sheet(isPresented: $showSortSheet) {
            sortBottomSheet
        }
    }
    
    // MARK: - ÏÉÅÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î∞î
    private var topNavigationBar: some View {
        HStack {
            Text("Í≤ÄÏÉâÍ≤∞Í≥º")
                .font(.system(size: 20, weight: .semibold))
                .padding(.leading, 8)
                .foregroundStyle(Color.black)
                .padding(.leading)

            Spacer()
            
            Button(action: {
                dismiss()
            }) {
                Text("ÎÇòÍ∞ÄÍ∏∞")
                    .foregroundStyle(Color.purple400)
            }
            .padding(.trailing)
        }
        .frame(height: 44)
        .background(Color(UIColor.systemBackground))
    }
    
    // MARK: - ÌïÑÌÑ∞ Î≤ÑÌäºÎì§
    private var filterButtonsRow: some View {
        HStack(spacing: 8) {
            // Í∞ÄÍ≤© ÌïÑÌÑ∞ Î≤ÑÌäº
            FilterChipButton(
                title: "0km ~ 150,000km",
                isSelected: false,
                action: {
                    // Í∞ÄÍ≤© ÌïÑÌÑ∞ Ïï°ÏÖò
                }
            )
            
            // Ï£ºÌñâÍ±∞Î¶¨ ÌïÑÌÑ∞ Î≤ÑÌäº
            FilterChipButton(
                title: "Ï£ºÌñâÍ±∞Î¶¨",
                isSelected: false,
                action: {
                    // Ï£ºÌñâÍ±∞Î¶¨ ÌïÑÌÑ∞ Ïï°ÏÖò
                }
            )
            
            Spacer()
            
            // Ï†ïÎ†¨ Î≤ÑÌäº
            Button(action: {
                showSortSheet = true
            }) {
                HStack(spacing: 4) {
                    Text("Ï†ïÎ†¨")
                        .font(.system(size: 14, weight: .medium))
                        .foregroundColor(.primary)
                    
                    Image(systemName: "chevron.down")
                        .font(.system(size: 12, weight: .medium))
                        .foregroundColor(.primary)
                }
            }
        }
        .padding(.horizontal, 16)
        .padding(.vertical, 12)
        .background(Color(UIColor.systemBackground))
    }
    
    // MARK: - Ï∞®Îüâ Î¶¨Ïä§Ìä∏
    private var vehiclesList: some View {
        Group {
            if viewModel.isSearching {
                // Î°úÎî© ÏÉÅÌÉú
                VStack {
                    Spacer()
                    ProgressView()
                        .scaleEffect(1.2)
                    Text("Í≤ÄÏÉâ Ï§ë...")
                        .font(.system(size: 16, weight: .medium))
                        .foregroundColor(.secondary)
                        .padding(.top, 16)
                    Spacer()
                }
            } else if viewModel.vehicles.isEmpty {
                // Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå
                emptyResultsView
            } else {
                // Í≤ÄÏÉâ Í≤∞Í≥º Î¶¨Ïä§Ìä∏ - üîß ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ
                ScrollView {
                    LazyVStack(spacing: 12) {
                        ForEach(Array(viewModel.vehicles.enumerated()), id: \.element.id) { index, vehicle in
                            NavigationLink {
                                CarDetailScreen(vehicleId: Int(vehicle.id))
                            } label: {
                                SearchResultCarCard(vehicle: vehicle)
                            }
                            .buttonStyle(.plain)
                            .onAppear {
                                // Î¨¥Ìïú Ïä§ÌÅ¨Î°§ - index Í∏∞Î∞òÏúºÎ°ú ÏàòÏ†ï
                                if index == viewModel.vehicles.count - 1 && viewModel.hasMoreData {
                                    Task {
                                        await viewModel.fetchFilteredCars(with: searchModel, isLoadMore: true)
                                    }
                                }
                            }
                        }
                        
                        // Îçî ÎßéÏùÄ Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïù∏ÎîîÏºÄÏù¥ÌÑ∞
                        if viewModel.isSearching && !viewModel.vehicles.isEmpty {
                            HStack {
                                Spacer()
                                ProgressView()
                                    .padding()
                                Spacer()
                            }
                        }
                    }
                    .padding(.horizontal, 16)
                    .padding(.top, 8)
                }
                .refreshable {
                    await viewModel.fetchFilteredCars(with: searchModel)
                }
            }
        }
    }
    
    // MARK: - Îπà Í≤∞Í≥º Î∑∞
    private var emptyResultsView: some View {
        VStack(spacing: 20) {
            Image(systemName: "car.fill")
                .font(.system(size: 60))
                .foregroundColor(.gray.opacity(0.5))
            
            VStack(spacing: 8) {
                Text("Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§")
                    .font(.system(size: 18, weight: .semibold))
                    .foregroundColor(.primary)
                
                Text("Îã§Î•∏ Í≤ÄÏÉâ Ï°∞Í±¥ÏúºÎ°ú ÏãúÎèÑÌï¥Î≥¥ÏÑ∏Ïöî")
                    .font(.system(size: 14))
                    .foregroundColor(.secondary)
            }
        }
        .frame(maxWidth: .infinity, maxHeight: .infinity)
        .padding()
    }
    
    // MARK: - Ï†ïÎ†¨ Î∞îÌÖÄÏãúÌä∏
    private var sortBottomSheet: some View {
        VStack(spacing: 0) {
            // Ìï∏Îì§
            RoundedRectangle(cornerRadius: 2)
                .fill(Color.gray.opacity(0.3))
                .frame(width: 36, height: 4)
                .padding(.top, 12)
                .padding(.bottom, 20)
            
            // ÌÉÄÏù¥ÌãÄ
            HStack {
                Text("Ï†ïÎ†¨")
                    .font(.system(size: 18, weight: .semibold))
                    .padding(.leading, 20)
                
                Spacer()
            }
            .padding(.bottom, 20)
            
            // Ï†ïÎ†¨ ÏòµÏÖòÎì§
            VStack(spacing: 0) {
                ForEach(["ÏµúÏã†Ïàú", "Í∞ÄÍ≤© ÎÇÆÏùÄÏàú", "Í∞ÄÍ≤© ÎÜíÏùÄÏàú", "Ï£ºÌñâÍ±∞Î¶¨ Ï†ÅÏùÄÏàú", "Ïó∞Ïãù ÏµúÏã†Ïàú"], id: \.self) { option in
                    Button(action: {
                        selectedSortOption = option
                        showSortSheet = false
                        // Ï†ïÎ†¨ Î°úÏßÅ Ïã§Ìñâ
                    }) {
                        HStack {
                            Text(option)
                                .font(.system(size: 16, weight: .medium))
                                .foregroundColor(.primary)
                            
                            Spacer()
                            
                            if selectedSortOption == option {
                                Image(systemName: "checkmark")
                                    .font(.system(size: 16, weight: .medium))
                                    .foregroundColor(.blue)
                            }
                        }
                        .padding(.horizontal, 20)
                        .frame(height: 48)
                    }
                }
            }
            
            Spacer()
        }
        .background(Color(UIColor.systemBackground))
        .presentationDetents([.height(300)])
    }
}

// MARK: - ÌïÑÌÑ∞ Ïπ© Î≤ÑÌäº
struct FilterChipButton: View {
    let title: String
    let isSelected: Bool
    let action: () -> Void
    
    var body: some View {
        Button(action: action) {
            Text(title)
                .font(.system(size: 14, weight: .medium))
                .foregroundColor(isSelected ? .white : .primary)
                .padding(.horizontal, 12)
                .padding(.vertical, 8)
                .background(
                    RoundedRectangle(cornerRadius: 16)
                        .fill(isSelected ? Color.blue : Color.gray.opacity(0.1))
                )
                .overlay(
                    RoundedRectangle(cornerRadius: 16)
                        .stroke(Color.gray.opacity(0.3), lineWidth: isSelected ? 0 : 1)
                )
        }
    }
}

// MARK: - Í≤ÄÏÉâ Í≤∞Í≥º Ï∞®Îüâ Ïπ¥Îìú
struct SearchResultCarCard: View {
    let vehicle: Vehicle
    @State private var isFavorite: Bool = false

    var body: some View {
        VStack(spacing: 0) {
            // Ï∞®Îüâ Ïù¥ÎØ∏ÏßÄ
            ZStack(alignment: .topTrailing) {
                AsyncImage(url: URL(string: vehicle.representativePhotoUrl ?? "")) { phase in
                    switch phase {
                    case .empty:
                        // Î°úÎî© Ï§ë placeholder
                        RoundedRectangle(cornerRadius: 12)
                            .fill(Color.gray.opacity(0.2))
                            .aspectRatio(16/10, contentMode: .fill)
                            .overlay(
                                Image(systemName: "car.fill")
                                    .font(.system(size: 40))
                                    .foregroundColor(.gray)
                            )
                    case .success(let image):
                        image
                            .resizable()
                            .aspectRatio(16/10, contentMode: .fill)
                            .clipShape(RoundedRectangle(cornerRadius: 12))
                    case .failure(_):
                        // Ïã§Ìå® Ïãú fallback
                        RoundedRectangle(cornerRadius: 12)
                            .fill(Color.gray.opacity(0.2))
                            .aspectRatio(16/10, contentMode: .fill)
                            .overlay(
                                Image(systemName: "car.fill")
                                    .font(.system(size: 40))
                                    .foregroundColor(.gray)
                            )
                    @unknown default:
                        EmptyView()
                    }
                }
                
                // Ï∞úÌïòÍ∏∞ Î≤ÑÌäº (Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ)
                Button(action: {
                    isFavorite.toggle()
                }) {
                    Image(systemName: isFavorite ? "heart.fill" : "heart")
                        .font(.system(size: 20))
                        .foregroundColor(isFavorite ? .red : .white)
                        .background(
                            Circle()
                                .fill(Color.black.opacity(0.3))
                                .frame(width: 36, height: 36)
                        )
                }
                .padding(.top, 12)
                .padding(.trailing, 12)
            }
            // Ï∞®Îüâ Ï†ïÎ≥¥
            VStack(alignment: .leading, spacing: 8) {
                HStack {
                    Text(vehicle.model ?? "Ï∞®ÎüâÎ™Ö")
                        .font(.system(size: 16, weight: .semibold))
                        .foregroundColor(.primary)
                    
                    Spacer()
                }
                
                HStack(spacing: 4) {
                    Text("\(vehicle.yearValue ?? 2024)ÎÖÑÏãù")
                        .font(.system(size: 12, weight: .medium))
                        .foregroundColor(.secondary)
                    
                    Text("‚Ä¢")
                        .font(.system(size: 12))
                        .foregroundColor(.secondary)
                    
                    Text("\(Int(vehicle.mileage ?? 0).formattedWithCommas())km")
                        .font(.system(size: 12, weight: .medium))
                        .foregroundColor(.secondary)
                    
                    Text("‚Ä¢")
                        .font(.system(size: 12))
                        .foregroundColor(.secondary)
                    
                    Text(vehicle.fuelType ?? "Ïó∞Î£åÌÉÄÏûÖ")
                        .font(.system(size: 12, weight: .medium))
                        .foregroundColor(.secondary)
                    
                    Spacer()
                }
                
                HStack {
                    Text("\(Formatters.priceText(won: vehicle.price ?? 0))")
                        .font(.system(size: 18, weight: .bold))
                        .foregroundColor(.primary)
                    
                    Spacer()
                }
            }
            .padding(.horizontal, 12)
            .padding(.vertical, 12)
        }
        .background(
            RoundedRectangle(cornerRadius: 12)
                .fill(Color(UIColor.systemBackground))
                .shadow(color: .black.opacity(0.08), radius: 8, x: 0, y: 2)
        )
    }
}

// MARK: - Int Extension for formatting
extension Int {
    func formattedWithCommas() -> String {
        let formatter = NumberFormatter()
        formatter.numberStyle = .decimal
        return formatter.string(from: NSNumber(value: self)) ?? "\(self)"
    }
}

#Preview {
    NavigationView {
        CarSearchResultsView(searchModel: CarSearchModel())
    }
}
